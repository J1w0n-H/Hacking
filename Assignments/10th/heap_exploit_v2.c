#include <stddef.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

struct auth {
    char name[32];     // 0x00-0x1F
    char pass[32];     // 0x20-0x3F
    int privilege;     // 0x40-0x43
    int padding;       // 0x44-0x47 (explicit padding)
    void (*callback)(); // 0x48-0x4F
} __attribute__((packed));

void normal_function() {
    printf("Normal function called\n");
}

void root_shell() {
    printf("Root shell spawned!\n");
    system("/bin/sh");
}

struct auth *auth1 = NULL;
struct auth *auth2 = NULL;

void debug_memory(const char* msg, struct auth* ptr) {
    printf("\n=== %s ===\n", msg);
    printf("auth struct at: %p\n", (void*)ptr);
    printf("callback offset: %ld\n", offsetof(struct auth, callback));
    printf("callback location: %p\n", &ptr->callback);
    printf("callback value: %p\n", ptr->callback);
}

int main() {
    char choice[16];
    int running = 1;
    
    printf("Size of auth: %zu\n", sizeof(struct auth));
    
    while(running) {
        printf("\nHeap Exploitation Menu:\n");
        printf("1. Create auth1 (small chunk)\n");
        printf("2. Create auth2 (small chunk)\n");
        printf("3. Free auth1\n");
        printf("4. Show memory\n");
        printf("5. Modify auth1\n");
        printf("6. Execute callback\n");
        printf("0. Exit\n");
        printf("Choice: ");
        
        if (fgets(choice, sizeof(choice), stdin) == NULL) break;
        
        switch(choice[0]) {
            case '1':
                auth1 = malloc(sizeof(struct auth));
                if(auth1) {
                    printf("Enter name: ");
                    fgets(auth1->name, 32, stdin);
                    memset(auth1->pass, 0, 32);
                    auth1->privilege = 0;
                    auth1->callback = normal_function;
                    debug_memory("After auth1 creation", auth1);
                }
                break;
                
            case '2':
                auth2 = malloc(sizeof(struct auth));
                if(auth2) {
                    memset(auth2, 0, sizeof(struct auth));
                    auth2->callback = normal_function;
                    debug_memory("After auth2 creation", auth2);
                }
                break;
                
            case '3':
                if(auth1) {
                    debug_memory("Before free", auth1);
                    free(auth1);
                    debug_memory("After free", auth1);
                }
                break;
                
            case '4':
                if(auth1) debug_memory("auth1 state", auth1);
                if(auth2) debug_memory("auth2 state", auth2);
                break;
                
            case '5':
                if(auth1) {
                    printf("Current callback location: %p\n", &auth1->callback);
                    void **callback_ptr = (void**)((char*)auth1 + offsetof(struct auth, callback));
                    *callback_ptr = root_shell;
                    printf("Modified callback to: %p\n", auth1->callback);
                    debug_memory("After modification", auth1);
                }
                break;
                
            case '6':
                if(auth1 && auth1->callback) {
                    printf("Executing callback at %p\n", auth1->callback);
                    auth1->callback();
                }
                break;
                
            case '0':
                running = 0;
                break;
        }
    }
    
    return 0;
}
