#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>

/* Structure definitions for testing different chunk sizes */
struct user_data {
    char name[32];    // Fastbin size
    char pass[256];   // Small bin size
    void (*func_ptr)(void);
};

/* Function to demonstrate privilege escalation */
void get_shell() {
    printf("Exploit successful - spawning shell\n");
    system("/bin/sh");
}

/* Normal function that should be called */
void normal_operation() {
    printf("Normal operation\n");
}

int main() {
    struct user_data *user1 = NULL;
    struct user_data *user2 = NULL;
    char input[32];
    int choice;

    while(1) {
        printf("\n1. Create user (fastbin)\n");
        printf("2. Create user (smallbin)\n");
        printf("3. Free user\n");
        printf("4. Modify data\n");
        printf("5. Execute function\n");
        printf("6. Exit\n");
        printf("Choice: ");
        
        fgets(input, sizeof(input), stdin);
        choice = atoi(input);

        switch(choice) {
            case 1:
                // Allocate fastbin-sized chunk
                user1 = malloc(sizeof(struct user_data));
                if(user1) {
                    user1->func_ptr = normal_operation;
                    printf("User1 created at: %p\n", (void*)user1);
                }
                break;

            case 2:
                // Allocate smallbin-sized chunk
                user2 = malloc(sizeof(struct user_data));
                if(user2) {
                    user2->func_ptr = normal_operation;
                    printf("User2 created at: %p\n", (void*)user2);
                }
                break;

            case 3:
                // Free user1 but keep pointer
                if(user1) {
                    free(user1);
                    printf("User1 freed but pointer retained\n");
                }
                break;

            case 4:
                // Use-after-free to modify freed memory
                if(user1) {
                    user1->func_ptr = get_shell;
                    printf("Modified freed memory\n");
                }
                break;

            case 5:
                // Execute function pointer
                if(user1 && user1->func_ptr) {
                    user1->func_ptr();
                }
                break;

            case 6:
                return 0;
        }
    }

    return 0;
}
